<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet"
    href="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dist/jquery.Thailand.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script type="text/javascript"
    src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dist/jquery.Thailand.min.js"></script>
  <script type="text/javascript"
    src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/JQL.min.js"></script>
  <script type="text/javascript"
    src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/typeahead.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pattaya&family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Sriracha&display=swap');

    body {
      background: url("https://archisite.sa/wp-content/uploads/2023/03/ICT-low-current.jpg") no-repeat center center fixed;
      background-size: cover;
      background-color: #f8f9faaa;
      font-family: 'Prompt', sans-serif;

      background-blend-mode: lighten;
    }

    .title {
      font-family: 'Pattaya', sans-serif;
    }

    .sub-title {
      font-family: 'Sriracha', sans-serif;
    }

    .nav-tabs .nav-link.active {
      background-color: #0d6efd;
      color: #fff;
    }

    .card-stat {
      border: none;
      border-radius: 15px;
      transition: transform 0.2s;
    }

    .card-stat:hover {
      transform: translateY(-5px);
    }

    .star-rating {
      font-size: 2.5rem;
      color: #ccc;
      cursor: pointer;
      display: inline-block;
    }

    .star-rating .fa-star.active {
      color: #ffc107;
    }

    .card-post-it {
      padding: 16px;
      border-radius: 3px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, .12);
      transition: .3s;
    }

    .bg-card {
      background: url("https://img.freepik.com/premium-photo/rectangular-cubes-abstract-bacgkround-3d-illustration-high-resolution_92790-3399.jpg") no-repeat center center fixed;
      background-size: cover;
    }

    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .card {
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, .12);
      transition: .3s;
    }

    .card-footer{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto; 
      background: #0000;
    } 

    .absolute-center-top {
      position: absolute;
      top: -0.15rem;          /* -top-1 -0.25*/
      left: 50%;              /* left-1/2 */
      transform: translateX(-50%);
      z-index: 10;
    }

    .parent {
      position: relative;
    }

    .name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .stars {
      color: #f59e0b;
    }

    .comment {
      font-size: .95rem;
    }

    .date {
      font-size:.8rem;
      opacity:.7;
      text-align: right;
    }

    .paginationx {
      margin-top: 30px;
      text-align: center;
    }

    .paginationx button {
      padding: 3px 10px;
      border: none;
      margin: 0 4px;
      border-radius: 8px;
      cursor: pointer;
      background: #fdb462;
    }

    .paginationx button.active {
      background: #eb6325;
      color: #fff;
    }
  </style>
</head>

<body>

  <div id="loader">
    <div class="spinner-border text-primary"></div>
  </div>
  <!-- header -->
  <div class="text-center py-4">
    <img class="mb-3" src="https://semicon.github.io/img/web/logoxxx.png" width="80">
    <h2 class="title">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</h2>
    <h3 class="sub-title">‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏£‡∏ß‡∏°‡∏™‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°</h2>
  </div>

  <div class="container py-4">
    <!-- menu -->
    <ul class="nav nav-tabs nav-justified mb-4" id="mainTab" role="tablist">
      <li class="nav-item">
        <button id="home" class="nav-link active  px-0" data-bs-toggle="tab" data-bs-target="#dash-tab" onclick="loadDashboard()">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      </li>
      <li class="nav-item">
        <button class="nav-link  px-0" data-bs-toggle="tab" data-bs-target="#reg-tab">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
      </li>
      <li class="nav-item">
        <button class="nav-link  px-0" id="rate-nav" data-bs-toggle="tab" data-bs-target="#rate-tab" onclick="chackStatus()">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
      </li>
      <li class="nav-item">
        <button class="nav-link  px-0" id="dl-nav" data-bs-toggle="tab" data-bs-target="#dl-tab" onclick="chackStatus()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
      </li>
    </ul>


    <!-- Content -->
    <div class="tab-content mt-3">
      <!-- Stat -->
      <div class="tab-pane fade show active" id="dash-tab">
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="card-stat shadow-sm p-3 text-center bg-white bg-opacity-50">
              <h5 class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h5>
              <h2 id="stat-users" class="text-primary fw-bold">0</h2>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card-stat shadow-sm p-3 text-center bg-white bg-opacity-50">
              <h5 class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß</h5>
              <h2 id="stat-ratings" class="text-info fw-bold">0</h2>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card-stat shadow-sm p-3 text-center bg-white bg-opacity-50">
              <h5 class="text-muted">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h5>
              <h2 id="stat-avg" class="text-warning fw-bold">0.00</h2>
            </div>
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card shadow-sm p-3 h-100 bg-white bg-opacity-50">
              <h5>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏≤‡∏ß</h5>
              <canvas class=" align-self-end mt-3" id="radarChart"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card shadow-sm p-3 h-100 bg-white bg-opacity-50">
              <h5>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h5>
              <canvas id="pieChart" class="mt-3"></canvas>
              <div style="text-align:center;margin-top:8px;">
                <button class="btn btn-sm" id="prevPie">
                  <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="#1f1f1f"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                </button>
                <span id="piePageInfo" class="text-muted text-small">1/1</span>
                <button class="btn btn-sm" id="nextPie">
                  <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="#1f1f1f"><path d="m321-80-71-71 329-329-329-329 71-71 400 400L321-80Z"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Post-it -->
        <div class="card shadow-sm p-4 h-100 bg-white bg-opacity-50 mt-3">
          <h5>üì¢ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
          <div id="cards" class="row g-3 mt-3"></div>
          <div id="spinner" class="text-center mt-3 d-none">
            <div class="spinner-border text-danger" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <div id="pagination" class="paginationx"></div>
        </div>
      </div>

      <!-- register Form -->
      <div class="tab-pane fade" id="reg-tab">
        <div class="card shadow-sm mx-auto bg-white bg-opacity-50" style="max-width: 600px;">
          <div class="card-body p-4">
            <h4 class="mb-4 text-center">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
            <form id="submitForm" onsubmit="submitReg()">
              <div class="mb-3">
                <label>‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="fname" class="form-control bg-white bg-opacity-50" required>
              </div>
              <div class="mb-3">
                <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="lname" class="form-control bg-white bg-opacity-50" required>
              </div>
              <div class="mb-3">
                <label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label><input type="text" id="agency" class="form-control bg-white bg-opacity-50" required>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label><input type="text" id="dist" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="prov" class="form-control" required>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100 py-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Rating Scale -->
      <div class="tab-pane fade" id="rate-tab">
        <div class="card shadow-sm mx-auto text-center bg-white bg-opacity-50" style="max-width: 600px;">
          <div class="card-body p-4">
            <h4>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</h4>
            <p class="text-muted small">ID: <span id="cur-id">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span></p>
            <div class="star-rating my-3" id="star-container">
              <i class="fa-solid fa-star" data-v="1"></i>
              <i class="fa-solid fa-star" data-v="2"></i>
              <i class="fa-solid fa-star" data-v="3"></i>
              <i class="fa-solid fa-star" data-v="4"></i>
              <i class="fa-solid fa-star" data-v="5"></i>
            </div>
            <textarea id="comment" class="form-control mb-3"  rows="3" maxlength="125" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
            <button id="btnRate" class="btn btn-warning w-100" onclick="submitRate()">‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à</button>
          </div>
        </div>
      </div>

      <!-- Download Files -->
      <div class="tab-pane fade text-center" id="dl-tab">
        <div class="py-5 shadow-sm mx-auto bg-white bg-opacity-50 card" style="max-width: 600px;">
          <div id="dl-icon-area">
            <i class="fa-solid fa-file-arrow-down fa-5x mb-3 text-success"></i>
          </div>
          <h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
          <div class="mx-auto" style="max-width: 400px;">
            <label for="projectSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</label>
            <select id="projectSelect" class="form-select bg-success bg-opacity-25">
              <option value=""> --- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå --- </option>
            </select>
            <button class="btn btn-primary btn-lg w-100 shadow-sm py-3 mt-3" id="mainDownloadBtn" onclick="checkAndDownload()" disabled>
              <i class="fa-solid fa-download me-2"></i> ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            </button>
          </div>
          <p class="text-success mt-4 mb-1" id="dl-status-text">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°</p>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center text-primary align-middle"
    style="height: 80px; display: flex; justify-content: center; align-items: center;">
    <p>Copyright ¬© 2025. ‚ù§Ô∏è <a href="https://guruchian.blogspot.com/" target="_blank"
        style="text-decoration:none;">GuruChian</a></p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    $.Thailand({
      $amphoe: $('#dist'), // input ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
      $province: $('#prov'), // input ‡∏Ç‡∏≠‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    });

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
    let state = {
      fullname: '',
      id: '', 
      registered: false, 
      rated: false, 
      stars: 0
    };

    let charts = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ charts
    const CACHE_KEY = 'download_data_x1';  // Key Local Storege
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    window.onload = () => {
      loadDashboard(); 
      load(1);
      loadFilesData()
    };
    
    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß
    let stars = 0
    document.querySelectorAll('.star-rating i').forEach(star => {
        star.onclick = function() {
          stars = this.dataset.v;
          state.stars = stars;
          document.querySelectorAll('.star-rating i').forEach(s => {
            s.classList.toggle('active', s.dataset.v <= state.stars);
          });
        };
    });
    
    // ---------------- load Dashboard --------------------
    function loadDashboard() {
      document.getElementById('loader').style.display = 'flex';
      const cachedData = localStorage.getItem(CACHE_KEY);
        if (cachedData) {
          try {
            const datax = JSON.parse(cachedData);
            document.getElementById('cur-id').innerText = datax.id ? datax.id : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
            state  = datax;
          } catch(e) { console.error("Cache error", e); }
        }
      google.script.run.withSuccessHandler(data => {
        document.getElementById('stat-users').innerText = data.cards.totalUsers;
        document.getElementById('stat-ratings').innerText = data.cards.totalRatings;
        document.getElementById('stat-avg').innerText = data.cards.avgStars;
        renderCharts(data);
        document.getElementById('loader').style.display = 'none';
      }).getDashboardData();
    }

    
  
    
    /** ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü ------------ */
    let legendPage = 1;
    const legendPageSize = 15;

    function renderCharts(data) {

      if (charts.radar) charts.radar.destroy();
      if (charts.pie) charts.pie.destroy();

      const totalLabels = data.provinces.labels.length;
      const totalPages = Math.ceil(totalLabels / legendPageSize);
      
      // ------------- 1. Pie Chart -------------------
      charts.pie = new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
          labels: data.provinces.labels,
          datasets: [{
            data: data.provinces.values,
            backgroundColor: [
              'rgb(255, 99, 132)',
              'rgb(255, 159, 64)',
              'rgb(255, 205, 86)',
              'rgb(75, 192, 192)',
              'rgb(54, 162, 235)',
              'rgb(153, 102, 255)',
              'rgb(201, 203, 207)',
              '#8dd3c7','#ffffb3',
              '#bebada','#fb8072',
              '#80b1d3','#fdb462'
            ],
            borderWidth: 1
          }]
        },

        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                pointStyle: 'circle',
                padding: 15,
                boxHeight: 8,

                // ‚≠ê KEY POINT
                filter: (legendItem) => {
                  const index = legendItem.index;
                  const start = (legendPage - 1) * legendPageSize;
                  const end = start + legendPageSize;
                  return index >= start && index < end;
                }
              }
            }
          }
        }
      });

      // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
      document.getElementById('piePageInfo').innerText =
        `${legendPage}/${totalPages}`;

      // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      document.getElementById('prevPie').onclick = () => {
        if (legendPage > 1) {
          legendPage--;
          charts.pie.update();
          updatePageInfo();
        }
      };
      
      // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      document.getElementById('nextPie').onclick = () => {
        if (legendPage < totalPages) {
          legendPage++;
          charts.pie.update();
          updatePageInfo();
        }
      };
      
      // ‡∏≠‡∏±‡∏ö‡πÄ‡∏î‡∏ó PageInfo
      function updatePageInfo() {
        document.getElementById('piePageInfo').innerText =
          `${legendPage}/${totalPages}`;
      }
      
      // ----------- 2. Radar Chart ---------------------
      charts.radar = new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
          labels: ['1 ‡∏î‡∏≤‡∏ß', '2 ‡∏î‡∏≤‡∏ß', '3 ‡∏î‡∏≤‡∏ß', '4 ‡∏î‡∏≤‡∏ß', '5 ‡∏î‡∏≤‡∏ß'],
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
            data: data.starDist, 
            borderColor: 'rgba(255, 99, 132)',
            backgroundColor: 'rgb(255, 99, 132, 0.5)',
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,   // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                pointStyle: 'circle',  // circle | rect | rectRounded | triangle | star
                padding: 10,
                boxHeight: 8
              }
            }
          }
        }
      })
    }

    
    /** ---------‡∏™‡∏£‡πâ‡∏≤‡∏á post-it ---------------- */
    // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Post-It
    const colors = [
      '#dcfce7', // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô
      '#ffedd5', // ‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô
      '#fef9c3', // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
      '#e0f2fe'  // ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô
    ];

    // ‡∏†‡∏≤‡∏û‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏±‡∏Å Post-It
    const img = [
      ['https://wichianp.github.io/web/pin-green3.png','40'],
      ['https://wichianp.github.io/web/pin-red.png','40'],
      ['https://wichianp.github.io/web/pin-blue.png','40']
    ];

    let currentPage = 1;  // ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const limit = 12;     // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡πà‡∏ô post-it ‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
    
    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡πâ‡∏≤‡∏á Post-It
    function load(page){
      document.getElementById('spinner').classList.remove('d-none')
      google.script.run.withSuccessHandler(render)
        .getRatings(page, limit);
    }
    
    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î Post-It
    function render(res){
      //console.log(res)
      const wrap = document.getElementById('cards');
      wrap.innerHTML = '';

      res.data.forEach(d=>{
        const randomImg = img[Math.floor(Math.random() * img.length)];
        const angle = (Math.random()*4-2).toFixed(2);
        const color = colors[Math.floor(Math.random()*colors.length)];
        const date = formatThaiIntl(d.date);
        const card = document.createElement('div');
        card.className = 'col-md-3 parent';
        card.style.transform = `rotate(${angle}deg)`;

        card.innerHTML = `
          <div class="absolute-center-top">
            <img src="${randomImg[0]}" alt="Description" width="${randomImg[1]}">
          </div>
          <div class="card card-post-it h-100" style="background:${color}; rotransform:rotate(${angle}deg); border-radius: 3px;">
            <div class="card-body">
              <div class="name">${d.name} ${d.surname}</div>
              <div class="comment sub-title">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp; ${d.comment}</div>
            </div>
            <div class="card-footer mt-3">
              <span class="stars">${'‚òÖ'.repeat(d.stars)}</span>
              <span class="date">${date}</span>
            </div>
          </div>
        `;

        wrap.appendChild(card);
      });
      
      renderPagination(res.total);
      document.getElementById('spinner').classList.add('d-none')

    }

    // 3. ‡πÅ‡∏õ‡∏•‡∏á ‡∏ß‡∏±‡∏ô ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÑ‡∏ó‡∏¢
    function formatThaiIntl(input){
      console.log(input)
      const [day,month,year] = input.split('/').map(Number);
      const date = new Date(year, month-1, day);
      const yearTH = date.getFullYear() + 543;
      const th = new Intl.DateTimeFormat('th-TH',{
        day:'numeric',
        month:'long'
      }).format(date);
      return `${th} ${yearTH}`;
    }

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤
    function renderPagination(total){
      const pages = Math.ceil(total / limit);
      const p = document.getElementById('pagination');
      p.innerHTML = '';

      if (pages <= 1) return;

      const maxButtons = 3;
      let start = Math.max(1, currentPage - 2);
      let end = Math.min(pages, currentPage + 2);

      if (end - start + 1 < maxButtons) {
        if (start === 1) {
          end = Math.min(pages, start + maxButtons - 1);
        } else if (end === pages) {
          start = Math.max(1, end - maxButtons + 1);
        }
      }

      // ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
      if (start > 1) {
        addButton(1);
        if (start > 2) addDots();
      }

      // ‡∏õ‡∏∏‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á
      for (let i = start; i <= end; i++) {
        addButton(i);
      }

      // ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
      if (end < pages) {
        if (end < pages - 1) addDots();
        addButton(pages);
      }
    }
    
    // 5. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤
    function addButton(page){
      const b = document.createElement('button');
      b.textContent = page;
      if (page === currentPage) b.classList.add('active');
      b.onclick = () => {
        currentPage = page;
        load(page);
      };
      document.getElementById('pagination').appendChild(b);
    }
    
    // 6. ‡πÄ‡∏û‡∏¥‡πà‡∏° ... ‡∏¢‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤
    function addDots(){
      const span = document.createElement('span');
      span.textContent = '. . .';
      span.style.margin = '0 6px';
      span.style.opacity = '.95';
      span.classList.add('fw-bold');
      document.getElementById('pagination').appendChild(span);
    }

    /** ------------ end post-it--------------------------*/

    
    /** ----------------- Download -------------------------- */
    // ------------ ‡∏™‡∏£‡πâ‡∏≤‡∏á select option -------------
    function loadFilesData(){
      google.script.run.withSuccessHandler(function(projects){
        const select = document.getElementById('projectSelect');
        projects.forEach(p=>{
          console.log(p.Free)
          const isFile = p.Free;
          if(isFile){
            const opt = document.createElement('option');
            opt.textContent = p.projectName;
            opt.value = p.projectUrl.split("/")[5];
            select.appendChild(opt);
          }
        });
      }).getProjects();
    }

    // ---------- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -----------------
    function chackStatus(){
      const regTabTrigger = document.querySelector('button[data-bs-target="#reg-tab"]');
      const rateTabTrigger = document.querySelector('button[data-bs-target="#rate-tab"]');
      const btnDownload = document.querySelector('#mainDownloadBtn');
      const btnRate = document.querySelector('#btnRate');

      // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
      if (!state.registered) {
        alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢: ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        bootstrap.Tab.getOrCreateInstance(regTabTrigger).show();
        btnRate.disabled = true;
        return;
      }

      // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
      if (!state.rated) {
        alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢: ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡∏ö");
        bootstrap.Tab.getOrCreateInstance(rateTabTrigger).show();
        return;
      }

      // 3. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      if(state.registered && state.rated){
        btnDownload.disabled = false;
      }
    }


    // ------------------ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ---------------
    function checkAndDownload() {
      const fileId = document.getElementById('projectSelect').value;
      const url = 'https://docs.google.com/spreadsheets/d/'+fileId+'/copy';
      //const url = 'https://docs.google.com/spreadsheets/d/'+state.fileId+'/copy'
      window.open(url, '_blank');
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
      document.getElementById('dl-status-text').classList.remove('text-success');
      document.getElementById('dl-status-text').classList.add('text-warning');
      document.getElementById('dl-status-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...";
      
      setTimeout(() => {
        document.getElementById('home').click()
      },1000);
    }

    // ---------------- ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ------------------
    function submitReg() {
      event.preventDefault();
      const data = {
        firstName: document.getElementById('fname').value,
        lastName: document.getElementById('lname').value,
        agency: document.getElementById('agency').value,
        district: document.getElementById('dist').value,
        province: document.getElementById('prov').value
      };
    
      // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å google.script.run
      google.script.run.withSuccessHandler(data => {
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        state = data ;
        document.getElementById('cur-id').innerText = data.id;
        
        // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        bootstrap.Tab.getOrCreateInstance(document.getElementById('rate-nav')).show();
      }).registerUser(data);
    }

    // ----------- ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏• ----------------
    function submitRate() {
      if(!state.registered) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
      if(stars === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≤‡∏ß');
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
      let datainfoApp = JSON.parse(localStorage.getItem(CACHE_KEY)) || {};

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤ rated
      datainfoApp.rated = true;

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ localStorage
      localStorage.setItem("datainfoApp", JSON.stringify(datainfoApp));

      const dataInfoRating = { 
        userId: state.id, 
        stars: state.stars, 
        comment: document.getElementById('comment').value 
      }

      google.script.run.withSuccessHandler(data => {
        state.rated = true;
        datainfoApp.rated = true;
        localStorage.setItem(CACHE_KEY, JSON.stringify(datainfoApp));
        document.getElementById('dl-icon-area').innerHTML = '<i class="fa-solid fa-circle-check fa-5x text-success mb-3"></i>';
        document.getElementById('dl-status-text').innerText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ";
        
        alert('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
        document.querySelectorAll('.star-rating i').forEach(s => {
          s.classList.remove('active', s.dataset.v <= state.stars);
        });

        setTimeout(() => {
          stars = 0;
          chackStatus();
          bootstrap.Tab.getOrCreateInstance(document.getElementById('dl-nav')).show();

        }, 500);
        
      }).submitRating(dataInfoRating);
    }

  </script>
</body>

</html>
